        <div class="title">Programa (ASM)</div>
        <div class="step-block">
            <ul>
               <li><div class="text">Como puedes ver en el video, el programa de esta lección va a hacer lo mismo que el programa de la lección anterior.</div></li>
               <li><div class="text">Pero vamos a optimizar la función <b>SendByte</b>, la vamos a programar en lenguaje ensamblador.</div></li>
            </ul>
                    <div class="video-div"><iframe src="https://www.youtube.com/embed/MSyBh5-Im1c?rel=0" frameborder="0" allowfullscreen></iframe></div>
        </div>
        <div class="title">Pasos</div>
        <div class="step-block">
            <ul>
               <li><div class="text">Vamos a crear un proyecto nuevo llamado <b>P17_Click4x4RGB_ASM</b> a partir del proyecto <b>P16_Click4x4RGB_HAL</b>.</div></li>
               <li><div class="text">Usa la opción de crear un proyecto a partir de un fichero de configuración <b>.ioc</b></div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/05.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Busca el fichero <b>.ioc</b> del proyecto <b>P16_Click4x4RGB_HAL</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/06.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/07.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Dale al nuevo proyecto el nombre <b>P17_Click4x4RGB_ASM</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/08.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/09.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Aquí puedes ver el nuevo proyecto.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/10.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Copia los ficheros de código fuente del proyecto <b>P16_Click4x4RGB_HAL</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/11.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/12.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/13.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/14.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/15.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Y cierra los demás proyectos.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/16.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/17.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Vamos a hacer las modificaciones en <b>main.c</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/18.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/19.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/20.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/21.png">
            <ul>
               <li><div class="text">He creado la variable <b>u32APP_GPIO_DIN_PORT</b> para que en ensamblador podamos acceder a la constante <b>LD2_GPIO_Port</b> y la variable <b>u32APP_GPIO_DIN_PIN</b> para acceder a la constante <b>LD2_Pin</b>.</div></li>
            </ul>
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Vamos a hacer las modificaciones en <b>AppClick4x4RGB.c</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/22.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/23.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">No necesitamos las funciones <b>write0</b>, <b>write1</b> ni <b>SendByte</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/24.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/25.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/26.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/28.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/29.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Añadimos el prototipo de la función <b>fSendByte</b> que implementaremos en lenguaje ensamblador.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/30.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Reemplaza las llamadas a la función <b>SendByte</b> por llamadas a la función <b>fSendByte</b>.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/31.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/32.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Vamos a añadir un fichero para nuestro código en ensamblador llamado <b>AppClick4x4ASM.s</b></div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/33.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/34.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/35.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Borro el contenido y copio el código en ensamblador que he preparado para esta lección.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/36.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/37.png">
            <table class="source-code-table">
                  <tr>
                      <td>1</td>
                      <td>    .syntax unified</td>
                  </tr>
                  <tr>
                      <td>2</td>
                      <td>    .thumb_func</td>
                  </tr>
                  <tr>
                      <td>3</td>
                      <td>    .text</td>
                  </tr>
                  <tr>
                      <td>4</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>5</td>
                      <td>    .equ    <span class="b1">BSRR_OFFSET<span class="tooltiptext">Este es el offset del registro BSRR dentro del puerto. El registro BSRR se utiliza para poner a 1 los bits del puerto A.</span></span>,    0x18</td>
                  </tr>
                  <tr>
                      <td>6</td>
                      <td>    .equ    <span class="b2">BRR_OFFSET<span class="tooltiptext">Este es el offset del registro BRR dentro del puerto. El registro BRR se utiliza para poner a 0 los bits del puerto A.</span></span>,     0x28</td>
                  </tr>
            </table>
            <table class="source-code-table">
                  <tr>
                      <td>8</td>
                      <td>/************************************************</td>
                  </tr>
                  <tr>
                      <td>9</td>
                      <td>    fSendByte</td>
                  </tr>
                  <tr>
                      <td>10</td>
                      <td>    <span class="b3">void fSendByte( uint8_t _u8Value )<span class="tooltiptext">La función <b>fSendByte</b> recibe el byte a enviar en el registro <b>r0</b>.</span></span>;</td>
                  </tr>
                  <tr>
                      <td>11</td>
                      <td>************************************************/</td>
                  </tr>
                  <tr>
                      <td>12</td>
                      <td>    .global fSendByte</td>
                  </tr>
                  <tr>
                      <td>13</td>
                      <td>    .func fSendByte</td>
                  </tr>
                  <tr>
                      <td>14</td>
                      <td>    .thumb_func</td>
                  </tr>
                  <tr>
                      <td>15</td>
                      <td>fSendByte:</td>
                  </tr>
                  <tr>
                      <td>16</td>
                      <td>    <span class="b4">PUSH    {r4,r5,r6,LR}<span class="tooltiptext">Guardamos en el stack los registros r4,r5,r6 y LR.</span></span></td>
                  </tr>
                  <tr>
                      <td>17</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>18</td>
                      <td>    <span class="b5">mov     r4,r0<span class="tooltiptext">Copiamos en r4 el valor a enviar.</span></span>     //r4 is the parameter _u8Value</td>
                  </tr>
                  <tr>
                      <td>19</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>20</td>
                      <td>    LDR     r3,<span class="b6">=u32APP_GPIO_DIN_PORT<span class="tooltiptext">Copiamos en r3 la dirección de la variable <b>u32APP_GPIO_DIN_PORT</b> que es la dirección base de los registros del puerto A.</span></span></td>
                  </tr>
                  <tr>
                      <td>21</td>
                      <td>    <span class="b1">LDR     r1,[r3]<span class="tooltiptext">Copiamos en r1 el contenido de la dirección de la variable <b>u32APP_GPIO_DIN_PORT</b>. Es decir, copiamos en r1 el valor de la variable <b>u32APP_GPIO_DIN_PORT</b>.</span></span></td>
                  </tr>
                  <tr>
                      <td>22</td>
                      <td>    LDR     r3,<span class="b2">=u32APP_GPIO_DIN_PIN<span class="tooltiptext">Copiamos en r3 la dirección de la variable <b>u32APP_GPIO_DIN_PIN</b>.</span></span></td>
                  </tr>
                  <tr>
                      <td>23</td>
                      <td>    <span class="b3">LDR     r2,[r3]<span class="tooltiptext">Copiamos en r2 el contenido de la dirección de la variable <b>u32APP_GPIO_DIN_PIN</b>. Es decir copiamos en r2 el valor de la variable <b>u32APP_GPIO_DIN_PIN</b>.</span></span></td>
                  </tr>
                  <tr>
                      <td>24</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>25</td>
                      <td>    <span class="b4">movs    r5,#0x80<span class="tooltiptext">r5 va a ser la máscara para recorrer los bits del valor a enviar. Lo inicializamos a 0x80 para empezar por el bit más alto.</span></span>  //r5 is u8Mask</td>
                  </tr>
                  <tr>
                      <td>26</td>
                      <td>fSendByte_BeginLoop:</td>
                  </tr>
                  <tr>
                      <td>27</td>
                      <td>    <span class="b5">cmp     r5,#0<span class="tooltiptext">Comparamos r5 (la máscara) con 0.</span></span></td>
                  </tr>
                  <tr>
                      <td>28</td>
                      <td>    <span class="b6">beq     fSendByte_End<span class="tooltiptext">Si la máscara es 0 hemos terminado y saltamos a la etiqueta <b>fSendByte_End</b>.</span></span></td>
                  </tr>
                  <tr>
                      <td>29</td>
                      <td>    <span class="b1">mov     r6,r5<span class="tooltiptext">En las líneas 29 a 32 hacemos un <b>and</b> de la máscara y el valor, si es 1 tenemos que generar un 1, si no un 0.</span></span></td>
                  </tr>
                  <tr>
                      <td>30</td>
                      <td>    ands    r6,r4</td>
                  </tr>
                  <tr>
                      <td>31</td>
                      <td>    cmp     r6,#0</td>
                  </tr>
                  <tr>
                      <td>32</td>
                      <td>    <span class="b2">beq     fSendByte_0<span class="tooltiptext">Si es un 0 saltamos a la etiqueta <b>fSendByte_0</b> en línea 63, si no, seguimos en la línea 33.</span></span></td>
                  </tr>
                  <tr>
                      <td>33</td>
                      <td><span class="b3">fSendByte_1<span class="tooltiptext">En las líneas 35 a 60 generamos un 1, que es 0.7us a nivel alto y 0.6us a nivel bajo.</span></span>:</td>
                  </tr>
                  <tr>
                      <td>34</td>
                      <td>    //1</td>
                  </tr>
                  <tr>
                      <td>35</td>
                      <td>    <span class="b4">STR     r2,[r1, #BSRR_OFFSET]<span class="tooltiptext">Pone a 1 el bit, del registro BSRR, correspondiente a la máscara, de esta manera ponemos un 1 en DIN. Vamos a ejecutar esta instrucción 17 veces para que el tiempo a nivel alto sea 0.7us.</span></span></td>
                  </tr>
                  <tr>
                      <td>36</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>37</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>38</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>39</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>40</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>41</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>42</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>43</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>44</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>45</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>46</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>47</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>48</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>49</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>50</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>51</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>52</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>53</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>54</td>
                      <td>    <span class="b5">STR     r2,[r1, #BRR_OFFSET]<span class="tooltiptext">Pone a 1 el bit, del registro BRR, correspondiente a la máscara, de esta manera ponemos un 0 en DIN. Vamos a ejecutar esta instrucción 7 veces para que el tiempo a nivel bajo sea 0.6us.</span></span></td>
                  </tr>
                  <tr>
                      <td>55</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>56</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>57</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>58</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>59</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>60</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>61</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>62</td>
                      <td>    <span class="b6">b       fSendByte_EndLoop<span class="tooltiptext">Saltamos a la etiqueta <b>fSendByte_EndLoop</b></span></span></td>
                  </tr>
                  <tr>
                      <td>63</td>
                      <td><span class="b1">fSendByte_0<span class="tooltiptext">En las líneas 65 a 83 generamos un 0, que es 0.35us a nivel alto y 0.8us a nivel bajo.</span></span>:</td>
                  </tr>
                  <tr>
                      <td>64</td>
                      <td>    //0</td>
                  </tr>
                  <tr>
                      <td>65</td>
                      <td>    <span class="b2">STR     r2,[r1, #BSRR_OFFSET]<span class="tooltiptext">Pone a 1 el bit, del registro BSRR, correspondiente a la máscara, de esta manera ponemos un 1 en DIN. Vamos a ejecutar esta instrucción 8 veces para que el tiempo a nivel alto sea 0.35us.</span></span></td>
                  </tr>
                  <tr>
                      <td>66</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>67</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>68</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>69</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>70</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>71</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>72</td>
                      <td>    STR     r2,[r1, #BSRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>73</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>74</td>
                      <td>    <span class="b3">STR     r2,[r1, #BRR_OFFSET]<span class="tooltiptext">Pone a 1 el bit, del registro BRR, correspondiente a la máscara, de esta manera ponemos un 0 en DIN. Vamos a ejecutar esta instrucción 10 veces para que el tiempo a nivel bajo sea 0.8us.</span></span></td>
                  </tr>
                  <tr>
                      <td>75</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>76</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>77</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>78</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>79</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>80</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>81</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>82</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>83</td>
                      <td>    STR     r2,[r1, #BRR_OFFSET]</td>
                  </tr>
                  <tr>
                      <td>84</td>
                      <td></td>
                  </tr>
                  <tr>
                      <td>85</td>
                      <td>    <span class="b4">b       fSendByte_EndLoop<span class="tooltiptext">Saltamos a la etiqueta <b>fSendByte_EndLoop</b></span></span></td>
                  </tr>
                  <tr>
                      <td>86</td>
                      <td>fSendByte_EndLoop:</td>
                  </tr>
                  <tr>
                      <td>87</td>
                      <td>    <span class="b5">lsrs    r5,r5,#1<span class="tooltiptext">Desplazamos un bit a la derecha la máscara.</span></span></td>
                  </tr>
                  <tr>
                      <td>88</td>
                      <td>    <span class="b6">b       fSendByte_BeginLoop<span class="tooltiptext">Saltamos al comienzo del bucle para hacer otra iteración.</span></span></td>
                  </tr>
                  <tr>
                      <td>89</td>
                      <td>fSendByte_End:</td>
                  </tr>
                  <tr>
                      <td>90</td>
                      <td>    <span class="b1">POP     {r4,r5,r6,PC}<span class="tooltiptext">Restauramos los registros r4 a r6 y el PC para retornar de la función.</span></span></td>
                  </tr>
                  <tr>
                      <td>91</td>
                      <td>    .endfunc</td>
                  </tr>
            </table>
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Compila el proyecto.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/38.png">
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/39.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Y depúralo.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/40.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Estas son dos capturas, con el osciloscopio, de un 0 en la señal DIN.</div></li>
               <li><div class="text">El tiempo en ON es 0.35 microsegundos.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/03.png">
            <ul>
               <li><div class="text">El tiempo en OFF es 0.8 microsegundo.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/04.png">
        </div>
        <div class="step-block">
            <ul>
               <li><div class="text">Estas son dos capturas de un 1 en la señal DIN.</div></li>
               <li><div class="text">El tiempo en ON es 0.7 microsegundos.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/01.png">
            <ul>
               <li><div class="text">El tiempo en OFF es 0.6 microsegundo.</div></li>
            </ul>
            <img class="img" src="../courses/04_STM32F0/Seccion05/L37_Program_ASM/img/02.png">
        </div>
